<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - Pet Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-cyan-600">Agende o Banho do seu Pet</h1>
            <p class="text-gray-600 mt-2">Veja nossos horários disponíveis e escolha o melhor para você!</p>
        </header>

        <div id="loading" class="text-center">
            <p class="text-lg animate-pulse">Carregando horários disponíveis...</p>
        </div>

        <div id="horarios-container" class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Os horários serão inseridos aqui pelo JavaScript -->
        </div>

        <!-- Modal de Agendamento -->
        <div id="modal-agendamento" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all" id="modal-content">
                <h2 class="text-2xl font-bold mb-4">Confirmar Agendamento</h2>
                <p class="mb-4">Você está agendando para: <strong id="modal-data-hora" class="text-cyan-600"></strong></p>

                <form id="form-agendamento">
                    <input type="hidden" id="dataHoraInput" name="dataHora">
                    
                    <div class="mb-4">
                        <label for="clienteId" class="block text-sm font-medium text-gray-700">Seu ID de Cliente</label>
                        <input type="text" id="clienteId" name="clienteId" placeholder="Cole seu ID de cliente aqui" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" required>
                         <p class="text-xs text-gray-500 mt-1">Ainda não tem ID? Simule com '60f8f8f8f8f8f8f8f8f8f8f8' ou cadastre-se na área de clientes.</p>
                    </div>

                    <div class="mb-4">
                        <label for="petNome" class="block text-sm font-medium text-gray-700">Nome do Pet</label>
                        <input type="text" id="petNome" name="petNome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                     <div class="mb-4">
                        <label for="servico" class="block text-sm font-medium text-gray-700">Serviço</label>
                        <select id="servico" name="servico" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                            <option>Banho e Tosa</option>
                            <option>Banho</option>
                            <option>Tosa</option>
                        </select>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" id="btn-cancelar" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                        <button type="submit" id="btn-confirmar" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700">Confirmar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Toast de Notificação -->
        <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300">
            Agendamento realizado com sucesso!
        </div>

    </div>

    <script>
        const API_URL = 'http://localhost:4000';
        const loadingDiv = document.getElementById('loading');
        const container = document.getElementById('horarios-container');
        const modal = document.getElementById('modal-agendamento');
        const modalContent = document.getElementById('modal-content');
        const modalDataHora = document.getElementById('modal-data-hora');
        const formAgendamento = document.getElementById('form-agendamento');
        const dataHoraInput = document.getElementById('dataHoraInput');
        const btnCancelar = document.getElementById('btn-cancelar');
        const toast = document.getElementById('toast');

        // Função para formatar a data e hora de forma amigável
        function formatarData(dataISO) {
            const data = new Date(dataISO);
            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const diaSemana = diasSemana[data.getDay()];
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            return `${diaSemana}, ${dia}/${mes} às ${hora}:${minuto}`;
        }

        // Função para carregar os horários disponíveis
        async function carregarHorarios() {
            try {
                const response = await fetch(`${API_URL}/agendamentos/horarios-disponiveis`);
                if (!response.ok) throw new Error('Falha ao buscar horários.');
                
                const horarios = await response.json();
                
                loadingDiv.classList.add('hidden');
                container.classList.remove('hidden');
                container.innerHTML = ''; // Limpa o container

                if (horarios.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center">Nenhum horário disponível no momento. Tente novamente mais tarde.</p>';
                    return;
                }

                horarios.forEach(slot => {
                    const dataObj = new Date(slot.data);
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200 text-center cursor-pointer hover:shadow-lg hover:border-cyan-500 transition-all duration-300';
                    card.innerHTML = `
                        <p class="font-bold text-lg text-gray-800">${formatarData(slot.data).split(',')[0]}</p>
                        <p class="text-sm text-gray-500">${formatarData(slot.data).split(',')[1]}</p>
                        <p class="text-2xl font-bold mt-2 text-cyan-600">${dataObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                        <p class="text-xs mt-2 font-medium ${slot.vagas > 1 ? 'text-green-600' : 'text-orange-500'}">${slot.vagas} vaga${slot.vagas > 1 ? 's' : ''} restante${slot.vagas > 1 ? 's' : ''}</p>
                    `;
                    card.addEventListener('click', () => abrirModal(slot.data));
                    container.appendChild(card);
                });

            } catch (error) {
                loadingDiv.classList.add('hidden');
                container.classList.remove('hidden');
                container.innerHTML = `<p class="col-span-full text-center text-red-500">Erro ao carregar horários: ${error.message}</p>`;
                console.error(error);
            }
        }

        function abrirModal(dataISO) {
            modalDataHora.textContent = formatarData(dataISO);
            dataHoraInput.value = dataISO;
            modal.classList.remove('hidden');
        }

        function fecharModal() {
            modal.classList.add('hidden');
            formAgendamento.reset();
        }

        function mostrarToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Evento de submissão do formulário
        formAgendamento.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btnConfirmar = document.getElementById('btn-confirmar');
            btnConfirmar.disabled = true;
            btnConfirmar.textContent = 'Agendando...';

            const formData = new FormData(formAgendamento);
            const dados = {
                cliente: formData.get('clienteId'),
                pet: { nome: formData.get('petNome') },
                dataHora: formData.get('dataHora'),
                servico: formData.get('servico')
            };

            try {
                const response = await fetch(`${API_URL}/agendamentos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Erro desconhecido.');
                }
                
                mostrarToast('Agendamento realizado com sucesso!');
                fecharModal();
                carregarHorarios(); // Recarrega para atualizar as vagas

            } catch (error) {
                mostrarToast(`Erro: ${error.message}`, true);
            } finally {
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = 'Confirmar';
            }
        });

        // Eventos para fechar o modal
        btnCancelar.addEventListener('click', fecharModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                fecharModal();
            }
        });

        // Carrega os horários ao iniciar a página
        document.addEventListener('DOMContentLoaded', carregarHorarios);
    </script>
</body>
</html>
